# Rate Limiter Spring Boot Starter

ä¸€ä¸ª**è½»é‡åŒ–**çš„é™æµç»„ä»¶ä¾èµ–åº“ï¼ŒåŸºäº AOP åˆ‡é¢ç¼–ç¨‹å®ç°ï¼Œé‡‡ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•å’Œé»‘åå•æœºåˆ¶ã€‚

## âœ¨ ç‰¹æ€§

- ğŸ¯ **è½»é‡åŒ–è®¾è®¡**ï¼šé›¶å¤–éƒ¨ä¾èµ–ï¼Œæ ¸å¿ƒä»£ç ç²¾ç®€ï¼Œä¸å¢åŠ é¡¹ç›®è´Ÿæ‹…
- ğŸš€ **å¼€ç®±å³ç”¨**ï¼šè‡ªåŠ¨é…ç½®ï¼Œå¼•å…¥ä¾èµ–å³å¯ä½¿ç”¨ï¼Œæ— éœ€ä»»ä½•é¢å¤–é…ç½®
- ğŸ“¦ **é«˜åº¦å¤ç”¨**ï¼šä½œä¸º jar åŒ…ä¾èµ–ï¼Œå¯å¿«é€Ÿé›†æˆåˆ°å¤šä¸ªé¡¹ç›®ä¸­
- ğŸ”§ **æ˜“äºç»´æŠ¤**ï¼šç‹¬ç«‹çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸï¼Œä¾¿äºç‰ˆæœ¬ç®¡ç†å’Œå‡çº§
- ğŸ›¡ï¸ **æ™ºèƒ½é˜²æŠ¤**ï¼šä»¤ç‰Œæ¡¶ç®—æ³• + é»‘åå•æœºåˆ¶ï¼ŒåŒé‡ä¿æŠ¤åº”ç”¨å®‰å…¨

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### 1. æ·»åŠ ä¾èµ–

#### Maven

```xml
<dependency>
    <groupId>com.example</groupId>
    <artifactId>rate-limiter-spring-boot-starter</artifactId>
    <version>1.0.0</version>
</dependency>
```

#### Gradle

```gradle
implementation 'com.example:rate-limiter-spring-boot-starter:1.0.0'
```

### 2. ç›´æ¥ä½¿ç”¨

**æ— éœ€ä»»ä½•é…ç½®**ï¼ç»„ä»¶æ”¯æŒ Spring Boot è‡ªåŠ¨é…ç½®ï¼Œå¼•å…¥ä¾èµ–åå³å¯ç›´æ¥ä½¿ç”¨ã€‚

åœ¨éœ€è¦é™æµçš„æ–¹æ³•ä¸Šæ·»åŠ  `@RateLimit` æ³¨è§£ï¼š

```java
@RateLimit(
    key = "userId",           // é™æµæ ‡è¯†ï¼ˆä»è¯·æ±‚å‚æ•°ä¸­æå–ï¼‰
    fallback = "drawError",   // é™æµæ—¶çš„å›è°ƒæ–¹æ³•
    qps = 1.0,               // æ¯ç§’å…è®¸è¯·æ±‚æ¬¡æ•°
    blacklistCount = 1       // é»‘åå•è§¦å‘æ¬¡æ•°
)
@PostMapping("/draw")
public Response<String> draw(@RequestBody DrawRequest request) {
    // ä¸šåŠ¡é€»è¾‘
    return success();
}

// é™æµå›è°ƒæ–¹æ³•
public Response<String> drawError(@RequestBody DrawRequest request) {
    return error("è®¿é—®é™æµæ‹¦æˆª");
}
```

## ğŸ“š æ ¸å¿ƒç»„ä»¶

### @RateLimit æ³¨è§£å‚æ•°

| å‚æ•°           | ç±»å‹   | é»˜è®¤å€¼ | è¯´æ˜                               |
| -------------- | ------ | ------ | ---------------------------------- |
| key            | String | "all"  | é™æµæ ‡è¯†å­—æ®µï¼Œæ”¯æŒä»è¯·æ±‚å‚æ•°ä¸­æå– |
| qps            | double | -      | æ¯ç§’å…è®¸è¯·æ±‚æ¬¡æ•°ï¼ˆå¿…å¡«ï¼‰           |
| blacklistCount | int    | 0      | é»‘åå•è§¦å‘æ¬¡æ•°ï¼Œ0 è¡¨ç¤ºä¸å¯ç”¨é»‘åå• |
| fallback       | String | -      | é™æµåçš„å›è°ƒæ–¹æ³•åï¼ˆå¿…å¡«ï¼‰         |

### é™æµç­–ç•¥

- **å…¨å±€é™æµ**ï¼š`key = "all"`ï¼Œæ‰€æœ‰è¯·æ±‚å…±äº«é™æµé…é¢
- **ç”¨æˆ·çº§é™æµ**ï¼š`key = "userId"`ï¼ŒæŒ‰ç”¨æˆ· ID ç‹¬ç«‹é™æµ
- **IP çº§é™æµ**ï¼š`key = "clientIp"`ï¼ŒæŒ‰ IP åœ°å€ç‹¬ç«‹é™æµ
- **è‡ªå®šä¹‰é™æµ**ï¼š`key = "è‡ªå®šä¹‰å­—æ®µ"`ï¼ŒæŒ‰æŒ‡å®šå­—æ®µé™æµ

### é»‘åå•æœºåˆ¶

å½“ç”¨æˆ·è§¦å‘é™æµæ¬¡æ•°è¶…è¿‡ `blacklistCount` æ—¶ï¼Œè¯¥ç”¨æˆ·å°†è¢«åŠ å…¥ 24 å°æ—¶é»‘åå•ï¼ŒæœŸé—´æ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ã€‚

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç”¨æˆ·æŠ½å¥–é™æµ

```java
@RestController
@RequestMapping("/api/activity")
public class ActivityController {

    @RateLimit(
        key = "userId",
        fallback = "drawError",
        qps = 1.0,
        blacklistCount = 1
    )
    @PostMapping("/draw")
    public Response<DrawResult> draw(@RequestBody DrawRequest request) {
        // æŠ½å¥–ä¸šåŠ¡é€»è¾‘
        return Response.success(drawResult);
    }

    public Response<DrawResult> drawError(@RequestBody DrawRequest request) {
        return Response.error("æŠ½å¥–è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
    }
}
```

### ç¤ºä¾‹ 2ï¼šå…¨å±€ API é™æµ

```java
@RateLimit(
    key = "all",
    fallback = "globalError",
    qps = 100.0
)
@GetMapping("/api/data")
public Response<Data> getData(@RequestParam String id) {
    // è·å–æ•°æ®é€»è¾‘
    return Response.success(data);
}

public Response<Data> globalError(@RequestParam String id) {
    return Response.error("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
}
```

### ç¤ºä¾‹ 3ï¼šIP çº§é™æµ

```java
@RateLimit(
    key = "all",  // å¯æ‰©å±•ä¸ºè·å–çœŸå®IP
    fallback = "ipLimitError",
    qps = 10.0,
    blacklistCount = 5
)
@PostMapping("/comment")
public Response<String> addComment(@RequestBody Comment comment) {
    // è¯„è®ºä¸šåŠ¡é€»è¾‘
    return Response.success("è¯„è®ºæˆåŠŸ");
}

public Response<String> ipLimitError(@RequestBody Comment comment) {
    return Response.error("è¯„è®ºè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
}
```

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸šåŠ¡é¡¹ç›®                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Controller    â”‚â”€â”€â”€â–¶â”‚   AOP Proxy     â”‚â”€â”€â”€â–¶â”‚Business â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              Rate Limiter ç»„ä»¶                         â”‚
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
    â”‚         â”‚   RateLimitAOP  â”‚                             â”‚
    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
    â”‚                 â”‚                                       â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
    â”‚   â–¼             â–¼             â–¼                         â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
    â”‚ â”‚TokenBuc â”‚ â”‚LocalCac â”‚ â”‚Blacklis â”‚                     â”‚
    â”‚ â”‚(ä»¤ç‰Œæ¡¶) â”‚ â”‚(æœ¬åœ°ç¼“å­˜)â”‚ â”‚(24h)   â”‚                     â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### å¯åŠ¨æµ‹è¯•é¡¹ç›®

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/yourkin666/rate-limiter.git
cd rate-limiter

# ç¼–è¯‘å®‰è£…
mvn clean install

# åˆ›å»ºæµ‹è¯•é¡¹ç›®å¹¶å¯åŠ¨
# (éœ€è¦åˆ›å»ºç¤ºä¾‹é¡¹ç›®æˆ–åœ¨ç°æœ‰é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–)
```

### API æµ‹è¯•

**æŠ½å¥–æ¥å£æµ‹è¯•**ï¼š

```bash
curl -X POST http://localhost:8080/api/activity/draw \
  -H "Content-Type: application/json" \
  -d '{"userId":"user001","activityId":"ACT001"}'
```

**å¿«é€Ÿè§¦å‘é™æµ**ï¼š

```bash
# è¿ç»­è°ƒç”¨å¤šæ¬¡ï¼Œè§‚å¯Ÿé™æµæ•ˆæœ
for i in {1..5}; do
  curl -X POST http://localhost:8080/api/activity/draw \
    -H "Content-Type: application/json" \
    -d '{"userId":"user001","activityId":"ACT001"}'
  echo ""
done
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

ç»„ä»¶æä¾›è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼š

```
2024-12-25 10:30:15.123 [http-nio-8080-exec-1] INFO  RateLimitAOP - é™æµæ ‡è¯†ï¼šuser001
2024-12-25 10:30:15.456 [http-nio-8080-exec-2] INFO  RateLimitAOP - é™æµ-è¶…é¢‘æ¬¡æ‹¦æˆªï¼šuser001
2024-12-25 10:30:16.789 [http-nio-8080-exec-3] INFO  RateLimitAOP - é™æµ-é»‘åå•æ‹¦æˆª(24h)ï¼šuser001
```

## âš™ï¸ é…ç½®å‚æ•°

åœ¨ `application.yml` ä¸­å¯ä»¥é…ç½®ï¼š

```yaml
# é™æµç»„ä»¶é…ç½®
rate-limiter:
  enabled: true # æ˜¯å¦å¯ç”¨é™æµç»„ä»¶ï¼Œé»˜è®¤true

# æ—¥å¿—é…ç½®
logging:
  level:
    com.example.ratelimiter: INFO
```

## ğŸ”§ æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½® QPS**ï¼šæ ¹æ®ç³»ç»Ÿå®¹é‡å’Œä¸šåŠ¡éœ€æ±‚è®¾ç½®åˆé€‚çš„é™æµé˜ˆå€¼
2. **é»‘åå•ç­–ç•¥**ï¼šè°¨æ…ä½¿ç”¨é»‘åå•åŠŸèƒ½ï¼Œé¿å…è¯¯åˆ¤æ­£å¸¸ç”¨æˆ·
3. **é”™è¯¯å¤„ç†**ï¼šæä¾›å‹å¥½çš„é™æµæç¤ºä¿¡æ¯ï¼Œä¿è¯ç”¨æˆ·ä½“éªŒ
4. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§é™æµè§¦å‘é¢‘ç‡ï¼ŒåŠæ—¶è°ƒæ•´ç­–ç•¥
5. **å›è°ƒæ–¹æ³•**ï¼šç¡®ä¿ fallback æ–¹æ³•ä¸åŸæ–¹æ³•å…·æœ‰ç›¸åŒçš„å‚æ•°ç­¾å

## ğŸš€ æ€§èƒ½ç‰¹ç‚¹

- **é«˜æ€§èƒ½**ï¼šåŸºäºæœ¬åœ°å†…å­˜ç¼“å­˜ï¼Œå“åº”æ—¶é—´ < 1ms
- **ä½å¼€é”€**ï¼šæ ¸å¿ƒä»£ç  < 10KBï¼Œå†…å­˜å ç”¨æå°‘
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨ ConcurrentHashMap å’ŒåŒæ­¥æœºåˆ¶ä¿è¯å¹¶å‘å®‰å…¨
- **è‡ªåŠ¨æ¸…ç†**ï¼šè¿‡æœŸæ•°æ®è‡ªåŠ¨æ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼
- **é›¶ä¾èµ–**ï¼šé™¤ Spring Boot å¤–æ— å…¶ä»–å¤–éƒ¨ä¾èµ–

## ğŸ¤” å¸¸è§é—®é¢˜

### Q: å¦‚ä½•ç¦ç”¨é™æµåŠŸèƒ½ï¼Ÿ

A: åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `rate-limiter.enabled=false`

### Q: æ”¯æŒåˆ†å¸ƒå¼é™æµå—ï¼Ÿ

A: å½“å‰ç‰ˆæœ¬åŸºäºæœ¬åœ°ç¼“å­˜ï¼Œå¦‚éœ€åˆ†å¸ƒå¼é™æµå»ºè®®ä½¿ç”¨ Redis ç­‰å¤–éƒ¨å­˜å‚¨

### Q: é»‘åå•æ•°æ®ä¼šæŒä¹…åŒ–å—ï¼Ÿ

A: é»‘åå•åŸºäºå†…å­˜ç¼“å­˜ï¼Œåº”ç”¨é‡å¯åä¼šæ¸…ç©º

### Q: å¯ä»¥è‡ªå®šä¹‰ä»¤ç‰Œæ¡¶ç®—æ³•å‚æ•°å—ï¼Ÿ

A: å½“å‰ç‰ˆæœ¬ä»¤ç‰Œæ¡¶å‚æ•°å›ºå®šï¼Œåç»­ç‰ˆæœ¬ä¼šå¼€æ”¾æ›´å¤šè‡ªå®šä¹‰é€‰é¡¹

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

**ç»„ä»¶ç‰ˆæœ¬**: v1.0.0  
**é€‚ç”¨æ¡†æ¶**: Spring Boot 2.x+  
**JDK ç‰ˆæœ¬**: 1.8+  
**ä½œè€…**: yourkin666  
**GitHub**: https://github.com/yourkin666/rate-limiter
